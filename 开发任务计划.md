**项目概述**
- 目标：构建一套 BSC(BNB Chain) 做市商机器人系统，支持批量生成/管理钱包地址，批量或单笔买卖代币，批量或单笔转账，并在此基础上接入可插拔做市策略、风控与监控。
- 范围：命令行工具（CLI）+ 模块化 SDK（钱包、DEX、交易、批处理、策略、风控、监控）。先实现稳定的链上交易与批处理能力，再逐步引入策略与监控。

**技术栈与依赖**
- 语言：Node.js 20+ 与 TypeScript
- 链接库：`ethers v6` 或 `viem`（择一；推荐 `viem` 简洁、tree-shaking 友好）
- DEX：PancakeSwap V2/V3 Router + SDK（后续可接聚合器 1inch/OpenOcean）
- 配置：`dotenv` + `TOML/YAML`（运行时配置与代币清单）
- 测试：Vitest/Jest + Foundry/Hardhat + Anvil（主网分叉）
- 日志：pino（JSON 结构化日志）
- 队列（可选）：BullMQ 或自研轻量任务池（并发与限速）

**目录结构（规划）**
- `src/`
  - `config/`：常量、配置解析（链 ID、WBNB、Router、滑点等）
  - `wallet/`：HD 钱包、批量派生、导入导出、加密存储
  - `dex/`：报价/路由、授权、买卖交易、BNB/WBNB 处理
  - `tx/`：交易发送、Gas 策略、Nonce 管理、dry-run/模拟
  - `batch/`：批量任务（买/卖/转账）、CSV/JSON 导入、并发控制
  - `strategy/`：做市策略接口、网格/基础报价策略
  - `risk/`：风控（滑点/价格影响/额度/白名单/黑名单）
  - `market/`：市场数据（WS 实时价格、K 线、深度、指标）
  - `monitor/`：指标、订阅、告警（Prometheus 可选）、异常检测
  - `persistence/`：数据持久化（SQLite/Postgres）、审计日志、报表
  - `cli/`：CLI 命令（wallet/trade/transfer/approve/quote/sweep 等）
  - `utils/`：通用工具、类型、安全工具
- `configs/`：`app.toml`、`tokens.yml`、`strategy.toml` 示例
- `tests/`：单元与集成测试
- `.env.example`、`README.md`

**功能模块与任务分解**
- 钱包与密钥
  - [ ] 支持 BIP39 助记词生成与校验；BIP44 路径 `m/44'/60'/0'/0/i`
  - [ ] 批量派生地址（指定数量/起始索引）；地址簿导出 CSV/JSON
  - [ ] 导入单私钥/keystore；可选从 CSV 导入
  - [ ] 本地加密存储（scrypt + AES-GCM）；口令管理与解锁缓存
  - [ ] 地址分组与标注（做市组/资金组/归集组）
- 链上交互与交易管道
  - [ ] Provider 管理（RPC 主/备、速率限制、健康检查）
  - [ ] Gas 策略（自动/手动、最大费率/优先费）
  - [ ] Nonce 管理（按钱包隔离、pending 跟踪、替换/撤销）
  - [ ] 交易 dry-run（`eth_call`）与失败原因解析
  - [ ] 归集/补 Gas 工具（sweep、小额聚合）
- DEX 交易（PancakeSwap）
  - [ ] 代币元数据与缓存（symbol/decimals）；WBNB 地址常量
  - [ ] Allowance 检查与最小授权（避免无限 approve）
  - [ ] 买入/卖出单笔交易（滑点、deadline）
  - [ ] 批量买入/卖出（并发与速率限制、失败重试）
  - [ ] 兼容 BNB/WBNB 自动 wrap/unwrap
  - [ ] 价格查询/报价（V2/V3 路由，优路径选择）
  - [ ] 限价/条件单（通过价格监听触发市价/限价模拟）
  - [ ] 跨池/跨 DEX 机会检测（简单套利探测，后续可扩展）
  - [ ] MEV 保护（私有交易/闪电bots/保护性参数，条件集成）
- 批量/单笔转账
  - [ ] BNB 与 ERC20 单笔转账
  - [ ] 批量转账（CSV 收款清单，支持金额/百分比）
  - [ ] 失败重试、部分成功报告
- 做市策略（可插拔）
  - [ ] 策略接口定义（行情输入、订单建议、库存更新）
  - [ ] 网格/阶梯策略（间距、格数、单格规模、跟随中间价）
  - [ ] 基础报价策略（点差、库存倾斜 skew）
  - [ ] 回测/模拟接口（主网分叉或离线行情）
  - [ ] 动态资金分配与多币种再平衡（rebalance）
- 风控与合规
  - [ ] 白名单/黑名单（代币/地址/路由）
  - [ ] 滑点与最大价格影响、最小成交量约束
  - [ ] 额度限制：单笔/单日/单钱包/全局
  - [ ] 非对称风控（买入/卖出分别限额）
  - [ ] 异常交易模式/价格操纵/流动性枯竭检测（基于监控与规则）
  - [ ] 资产集中度控制与动态限额调整
  - [ ] 合规接口：可疑地址检测、报表导出、KYC/AML 预留
- 监控与日志
  - [ ] pino 结构化日志、请求/交易上下文 ID
  - [ ] 指标（成交量、失败率、滑点分布、余额、nonce 延迟）
  - [ ] 告警通道（邮件/Slack/钉钉/企业微信，可插拔）
  - [ ] Web 控制台（可选 React/Vue）：实时交易监控、性能可视化、告警查询
 - 市场数据与分析
  - [ ] 实时价格订阅（WebSocket）、盘口/深度快照与增量
  - [ ] K 线获取与技术指标（MA/EMA/RSI 等）
  - [ ] 价格异常检测（快速拉升/暴跌阈值报警）
- CLI 命令（草案）
  - [ ] `wallet:generate --count N [--mnemonic-out path]`
  - [ ] `wallet:list`、`wallet:export --out addresses.csv`、`wallet:import ...`
  - [ ] `trade:buy --token 0x... --amount 1BNB --slippage 0.5% [--wallet 0x..]`
  - [ ] `trade:sell --token 0x... --amount 100T --slippage 0.5%`
  - [ ] `trade:buy:batch --csv wallets.csv --token 0x... --per-wallet 0.1BNB`
  - [ ] `transfer --to 0x... --token USDT --amount 100`
  - [ ] `transfer:batch --csv recipients.csv`
  - [ ] `approve --token 0x... --spender ROUTER --amount ...`
  - [ ] `allowance --token 0x... --owner 0x... --spender ROUTER`
  - [ ] `quote --token-in BNB --token-out 0x... --amount 1`
  - [ ] `sweep --min 0.01BNB --to 0xTREASURY`
  - [ ] `nonce:repair --wallet 0x...`、`tx:status --hash 0x...`
  - [ ] `bot start --strategy grid --config strategy/grid.toml`
  - [ ] `bot stop --strategy grid`
  - [ ] `bot status --all`
  - [ ] `bot rebalance --target-ratio 50:50`
  - [ ] `bot emergency-stop --reason "market-crash"`

**配置与文件**
- `.env`：`RPC_URL`、`RPC_BACKUP_URLS`、`ENCRYPTION_PASSWORD`、`ALERT_WEBHOOK` 等
- `configs/app.toml`：链 ID、WBNB、Router、默认滑点、并发/限速、重试策略、RPC 优化
- 参考 `configs/app.toml` 片段：

```
[rpc]
primary_urls = ["https://bsc-dataseed1.binance.org/"]
backup_urls  = [
  "https://bsc-dataseed2.binance.org/",
  "https://bsc-dataseed3.binance.org/",
]
max_retries = 3
timeout_ms = 10000
rate_limit_per_second = 10
health_check_interval = 30
```
- `configs/tokens.yml`：代币清单（address, symbol, decimals, whitelist? blacklisted?）
- `configs/strategy.toml`：网格/基础报价参数、库存目标、风险偏好
- `README.md`：安装、配置、运行、风险提示

**里程碑计划与验收标准（优先级调整版）**
- M1 核心交易功能（高优先级，预计 5–8 天）
  - 交付：钱包管理（批量生成/导入/导出）、单笔/批量买卖、基础风控（滑点/限额/白名单）、授权最小化、交易管道基础（Gas/Nonce/重试）
  - 验收：分叉/测试网完成 10+ 笔买卖与 3+ 批量操作，失败可复现并自动降级，日志可追踪
- M2 数据与监控（中优先级，预计 4–7 天）
  - 交付：市场数据（WS、K 线、深度、指标）、交易历史落库（SQLite/Postgres 可切换）、基础报表与监控指标、告警
  - 验收：Web 控制台/指标面板可查看实时/历史数据，异常检测可触发告警
- M3 高级策略（中优先级，预计 5–8 天）
  - 交付：网格策略、条件单（止损/止盈/限价模拟）、简单跨池套利探测、智能风控规则（异常交易/流动性枯竭等）
  - 验收：24 小时模拟/分叉回测通过，策略参数生效，风险事件被识别并限流
- M4 运维与安全（低优先级，预计 4–7 天）
  - 交付：容器化部署（Dockerfile）、CI/CD（测试/质量/安全扫描/自动部署）、硬件钱包/多签适配（预留）、紧急停止/再平衡工具
  - 验收：一键构建与部署成功，紧急停止与恢复流程可用，关键操作具备二次确认

**测试计划**
- 单元测试：钱包派生、授权与滑点计算、金额换算与精度、BNB/WBNB wrap/unwrap
- 集成测试：主网分叉对路由/交易进行端到端测试；批量转账成功/失败路径
- 性能测试：并发度/速率限制对延迟与失败率影响；Provider 退避策略
- 回测/模拟：策略在历史/分叉数据上的收益与风险评估

**安全与合规**
- 最小授权、地址与代币白/黑名单；禁止对未知/高风险代币做无限授权
- 私钥本地加密，分层钱包（冷/热），口令与配置分离（`.env` 不入库密钥）
- 额度与滑点上限默认严格；生产环境需二次确认/多签（后期可接入）
 - 硬件钱包（Ledger/Trezor）与多重签名（多签钱包）预留接口
 - 敏感操作二次确认机制；API 密钥轮换与最小权限

**运维与监控**
- 结构化日志 + 轮转；Prometheus 指标与 Grafana（可选）
- 告警：失败率/余额/nonce 异常/价格偏移阈值
- 脚本：归集、补 Gas、数据导入导出
 - 连接池复用、批量查询与路径缓存；RPC 健康检查与退避
 - Web 控制台（可选）统一查看交易/性能与告警历史

**风险与缓解**
- 链上拥堵/节点不稳定：多 RPC、重试与退避、分发流量
- 价格波动与滑点：滑点与价格影响控制、拆单
- 非法代币与黑名单：配置白/黑名单，预检代币元数据
- Nonce 冲突与卡单：独立 nonce 池、替换/撤销逻辑

**时间与资源预估（可滚动调整）**
- 总周期：约 22–35 人天（核心功能），高级策略/可视化另计
- 优先级：按 M1→M4（核心交易→数据监控→高级策略→运维安全）

**验收清单（关键点）**
- [ ] 批量钱包生成/导入/导出可用，数据可审计
- [ ] 单笔/批量转账在测试网与分叉网通过
- [ ] 单笔/批量买卖在分叉网稳定运行，滑点/价格影响受控
- [ ] Nonce/Gas/重试/替换机制在压力下稳定
- [ ] 策略模块可插拔，网格与基础报价策略可跑
- [ ] 监控与告警可用，日志可追踪
- [ ] 文档与配置齐备，可一键部署/回滚

**下一步（建议）**
- 在 `/Users/ph88vito/project/BNB` 初始化项目骨架与 CLI 基础命令：
  - `pnpm init` + TS 工程化（tsconfig、eslint、prettier）
  - 目录与配置样例落地（configs/.env.example）
  - `wallet:generate`、`wallet:export`、`transfer` 最小可用版
  - README 初稿与安全提示
 - 可选：添加容器化与 CI/CD 基础：
   - `Dockerfile`（Node 20 Alpine，生产依赖、构建与启动）
   - GitHub Actions/CI：单元测试、lint、SAST/依赖安全扫描
